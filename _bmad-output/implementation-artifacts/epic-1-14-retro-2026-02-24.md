# Retrospective: Epic 1 + Epic 14 — Combined Review

**Date:** 2026-02-24
**Epics Reviewed:** Epic 1 (Project Foundation & Secure Access) + Epic 14 (Public Website & Scheme Information)
**Sprints Covered:** Sprint 1 (Epic 1) + Sprint 2 (Epic 14)
**Facilitator:** Bob (Scrum Master)
**Status:** Complete

---

## Team Participants

- Bob (Scrum Master) — Facilitator
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical architecture
- Dana (QA Engineer) — Quality & testing
- Elena (Junior Dev) — Implementation perspective
- Awwal (Project Lead) — Overall direction & decisions

---

## Epic Summary & Metrics

### Delivery

| Metric | Value |
|---|---|
| Total Stories | 15 (12 Epic 1 + 3 Epic 14) |
| Completed | 15/15 (100%) |
| Sprints Used | 2 |
| Test Suite | 443+ tests (288 client, 141 server, 12 shared, 2 testing) |
| Code Review Issues | 68+ documented across stories |
| Production Incidents | 2 (both resolved) |

### Epic 1 Stories (Sprint 1)

| Story | Title | Status |
|---|---|---|
| 1.1 | Monorepo Scaffold & Development Environment | Done |
| 1.2 | User Registration & Login | Done |
| 1.3 | Session Security & Token Refresh | Done |
| 1.4 | Role-Based Access Control | Done |
| 1.5 | Audit Logging & Action Tracking | Done |
| 1.6 | Frontend Authentication Shell | Done |
| 1.7 | CI/CD Pipeline & Production Infrastructure | Done |
| 1.8a | Design Foundation, Priority Components & Mock Data Layer | Done |
| 1.8b | Role-Specific Screens, Demo Seed & Wiring Map | Done |
| 1.9a | User Account Lifecycle API & Email Invitation | Done |
| 1.9b | User Administration Interface, Profile Self-Service & First-Login | Done |
| 1.10 | Drizzle Versioned Migrations & Automated Schema Deployment | Done |

### Epic 14 Stories (Sprint 2)

| Story | Title | Status |
|---|---|---|
| 14.1 | Homepage & Navigation Shell | Done |
| 14.2 | About & Scheme Information Pages | Done |
| 14.3 | Resources, Support & Legal Pages | Done |

### Business Outcomes

- Full authentication & RBAC system live in production
- CI/CD pipeline deploying to oyocarloan.com.ng
- 16-route public website with scheme information, resources, legal pages
- Role-specific dashboards (super_admin, dept_admin, mda_officer) with mock data
- User account lifecycle (invite, password reset, deactivation) operational
- Design system with Oyo State branding (crimson, teal, gold) established

---

## Successes — What Went Well

### 1. Gated Workflow Excellence
The story creation → PM validation → development → review → commit cycle was the team's strongest asset. Every story that passed through the full pipeline shipped successfully. Each gate caught different categories of problems — PM validation prevented scope drift, code review caught architectural missteps, commit history created a forensic trail.

### 2. Middleware Chain Architecture (Stories 1.2-1.5)
The authenticate → authorise → scopeToMda → validate → auditLog → handler pattern, established early, accelerated all subsequent API work. Once the pattern existed, every new endpoint snapped into place without rethinking the request pipeline.

### 3. Content-First Data Pattern (Epic 14)
TypeScript content files (homepage.ts, news.ts, navigation.ts) enabled fast delivery of 3 stories with zero production issues. CMS-migration-ready from day one — future Sanity CMS integration requires import changes only, no component modifications.

### 4. Test Suite Growth
From zero to 443+ tests across the monorepo. BDD-style acceptance criteria in every story file made verification unambiguous — QA never had to guess what "done" meant.

### 5. Production Incident Response
When the server crashed due to the schema mismatch, the team traced the problem through commit history and Drizzle ORM source code, identified the root cause, wrote a fix with recovery logic, added 14 unit tests, and had the site back up via PR #22. Fast, collaborative, no blame.

### 6. CI/CD Pipeline (Story 1.7)
Automated lint → typecheck → test → build → deploy on every merge to main. Caught regressions silently throughout both epics. The Dockerfile multi-stage build with `drizzle/` folder copy was a small detail that became critical when migrations moved to runtime.

### 7. shadcn/ui + Design Foundation (Stories 1.8a, 14.1-14.3)
Pre-built accessible components (Accordion, NavigationMenu, Tabs, Breadcrumb) eliminated custom component bugs. Combined with the Oyo State design tokens, Epic 14's three stories moved fast with consistent styling.

---

## Challenges — What Didn't Go Well

### 1. Schema Management Assumptions (2 Production Incidents)

**Incident 1 — Schema Drift (pre-Story 1.10):**
Static `init-schema.sql` silently diverged from the Drizzle ORM schema. The `must_change_password` column existed in the ORM schema but never made it to production. Server crashed because Drizzle expected a column that didn't exist.

**Incident 2 — Baseline Schema Mismatch (Story 1.10):**
The fix for schema drift introduced a second bug. `baselineIfNeeded()` created the tracking table in `public.__drizzle_migrations` but Drizzle ORM internally uses `drizzle.__drizzle_migrations`. Migration 0000 re-ran, hit `CREATE TYPE "public"."role"` (already exists), server crash loop.

**Root cause:** Framework internal behaviour (Drizzle's `migrationsSchema = 'drizzle'`) was not documented clearly and was not verified against source code before implementation.

### 2. Missing Integration Test Layer
Both production incidents shared the same gap — no integration testing against a real PostgreSQL instance. Unit tests with mocks verified logic but missed framework behaviour. The baseline schema target, the trigger enforcement, the migration tracking — all untestable with mocks.

### 3. Third-Party Library API Surprises
- `csrf-csrf` v4: Different API from docs (`generateCsrfToken` not `generateToken`), session binding order mattered
- Drizzle ORM: Transaction rollback behaviour silently undid revocations, schema convention undocumented
- These required reading source code to resolve, not just documentation

### 4. UAT Discoveries Appeared as Scope Creep
Higher rework counts on some stories (1.1: 14 issues, 1.3: 10, 1.10: 16) appeared concerning. Awwal clarified: many of these came from his hands-on UAT testing, which surfaced real user needs not anticipated in the spec. This was the system working correctly — UAT feedback feeding back into stories as refinement, not rework.

---

## Key Insights & Learnings

1. **Bugs are inevitable — blame is wasteful — strengthening detection layers is the work.** The team's response model is: discover → diagnose collaboratively → fix → add detection to prevent recurrence.

2. **UAT by the Project Lead is a critical quality gate.** Awwal's testing caught real issues that specs and code review missed. Needs formalisation with structured checkpoints every 2-3 stories.

3. **Integration tests are the missing detection layer.** Mocks verify logic; integration tests verify framework behaviour. Critical for Epic 2's database triggers and financial precision.

4. **No framework assumptions without source verification.** When behaviour isn't covered by an integration test, it's an unverified assumption that can cause production incidents.

5. **Commit history is a first-class retrospective input.** The production crash diagnosis relied entirely on commit archaeology. Formalising this with a layered approach (story summaries + automated reports + incident deep dives) strengthens future retros.

6. **Retrospective action items must live in the sprint tracking system.** Items that float outside the gated workflow get lost. Story 2.0 and epic carry-forward sections ensure every commitment is tracked.

---

## Previous Retrospective Follow-Through

N/A — This is the first retrospective. No prior action items to review.

---

## Production Incidents

### Incident 1: Schema Drift (2026-02-23)
- **Impact:** Server crash, site down
- **Root cause:** `init-schema.sql` used `CREATE TABLE IF NOT EXISTS` which silently skips new columns
- **Resolution:** Story 1.10 — switched to Drizzle versioned migrations
- **Prevention:** Automated migrations on every server startup; no static SQL scripts

### Incident 2: Migration Baseline Schema Mismatch (2026-02-23)
- **Impact:** Server crash loop, deployment failure (PRs #20, #21)
- **Root cause:** Baseline wrote to `public.__drizzle_migrations` instead of `drizzle.__drizzle_migrations`
- **Resolution:** PR #22 — corrected schema target, added empty-table recovery, cleanup of stale table
- **Prevention:** Integration test layer (Story 2.0) will verify schema targets against real PostgreSQL

---

## Next Epic Preview: Epic 2 — Loan Data Management & Financial Computation

**Stories:** 8 (2.0 through 2.7)
**Focus:** Financial computation core — immutable ledger, deterministic math, audit traceability

### Dependencies on Epic 1+14

- User auth & JWT tokens (1.2/1.3) → ledger audit trail `posted_by` FK
- RBAC framework (1.4) → MDA-scoped loan search in Story 2.6
- Audit logging (1.5) → immutable ledger design pattern reused in Story 2.2
- Drizzle versioned migrations (1.10) → all new tables use same migration workflow
- 63 MDA seeds (1.8b) → FK relationships for loan master records

### Key Risks

- **Computation engine correctness** — all arithmetic must use `decimal.js`, verified to kobo precision
- **Immutable ledger design** — any flaw blocks all subsequent epics (3, 5, 10, 12)
- **Integration test gap** — Story 2.0 must establish the layer before Story 2.2

### Real-World Test Assets

- **Sports Council CSV** (`docs/NEW CAR LOAN TEMPLATE APRIL, 2025_Sheet1.csv`): 21 real loan records with known correct calculations — validation fixture for computation engine
- **Authoritative MDA List** (`docs/mdas_list.txt`): 63 Oyo State MDAs with official full names — replaces placeholder seed data

---

## Action Items

### Process Improvements

| # | Action | Owner | When | Success Criteria |
|---|---|---|---|---|
| 1 | Add `## Commit Summary` section to every story file at completion | Charlie | Starting Story 2.1 | Every completed story has: commit count, files touched, revert count, one-sentence dev arc |
| 2 | Formalise UAT checkpoints with "What to Test" checklists | Alice + Awwal | Every 2-3 stories in Epic 2 | Structured checklist at each checkpoint; findings logged as story amendments |
| 3 | Build automated retro report script (commit stats per story) | Charlie | Sub-task in Story 2.0 | Script outputs markdown summary table: commit count, file churn, fix% vs feat%, reverts |

### Technical Debt / Detection Layer

| # | Action | Owner | When | Success Criteria |
|---|---|---|---|---|
| 4 | Add integration test layer with PostgreSQL service container in CI | Charlie + Dana | Story 2.0 (before Story 2.2) | CI includes PostgreSQL service; migration baseline and trigger enforcement tested against real DB |
| 5 | Reconcile MDA seed data with authoritative list | Charlie + Awwal | Story 2.1 | All 63 MDAs match `docs/mdas_list.txt`; schema has `abbreviation` column + `mda_aliases` table |
| 6 | Commit Sports Council CSV as computation engine test fixture | Elena | Story 2.3 | CSV in `fixtures/`; tests validate engine output against known correct values to kobo precision |

### Team Agreements

| # | Agreement |
|---|---|
| 7 | No framework assumptions without source verification — if behaviour isn't covered by an integration test, it's unverified |
| 8 | Bugs are collective — roll up sleeves together. Focus on diagnosis and fix, not blame |
| 9 | UAT discoveries are features, not scope creep. Log as story amendments with clear traceability |

---

## Epic 2 Preparation Tasks

### Technical Setup

- [ ] Add `abbreviation` column + `mda_aliases` table to MDA schema (Story 2.1)
- [ ] Generate standardised abbreviations for all 63 MDAs — Charlie generates, Awwal reviews (Story 2.1)
- [ ] Add PostgreSQL service container to GitHub Actions CI pipeline (Story 2.0)
- [ ] Commit Sports Council CSV to `fixtures/` directory (Story 2.3)

### Knowledge Development

- [ ] Research `decimal.js` patterns: rounding modes, precision config, Drizzle NUMERIC→string handling (Story 2.3)
- [ ] Study immutable ledger patterns: DB trigger + ORM middleware + API rejection (Story 2.2)

### Cleanup

- [ ] Update Epic 1+14 status to "done" in sprint-status.yaml

---

## Critical Path

| # | Blocker | Owner | Risk if Skipped |
|---|---|---|---|
| 1 | Integration test layer must exist before Story 2.2 | Charlie + Dana | Same category of production incident — DB triggers untested against real PostgreSQL |
| 2 | MDA data reconciliation must complete in Story 2.1 | Charlie + Awwal | All subsequent stories FK to incorrect MDA agencies |
| 3 | `decimal.js` validation against Sports Council CSV | Elena | Computation engine produces different numbers than real-world data — erodes trust |

---

## Readiness Assessment

| Dimension | Status | Notes |
|---|---|---|
| Testing & Quality | Ready | 443+ tests passing, CI green, both incidents resolved |
| Deployment | Live | oyocarloan.com.ng operational after PR #22 |
| Stakeholder Acceptance | Pending | Public website live; formal UAT checkpoint recommended |
| Technical Health | Stable | Middleware chain, migration system, design foundation solid. Dashboards on mock data by design |
| Unresolved Blockers | None | Story 2.0 addresses infrastructure gap before Story 2.2 |

---

## New Story Added: Story 2.0

**Story 2.0: Sprint Infrastructure & Quality Gates** has been added to Epic 2 as a prerequisite story. It captures the infrastructure improvements identified in this retrospective:

- PostgreSQL service container in GitHub Actions CI
- Integration test scaffolding
- Commit summary convention in story template
- Automated retro report script (basic version)
- UAT checkpoint checklist template

This story runs first (can parallel with 2.1) and must complete before Story 2.2 begins.

---

## Retrospective Carry-Forward → Epic 2

All action items from this retrospective have been incorporated into Epic 2's planning:

| Retro Action Item | Mapped To |
|---|---|
| Integration test layer | Story 2.0 acceptance criteria |
| Automated retro report script | Story 2.0 acceptance criteria |
| Commit summary convention | Story 2.0 acceptance criteria |
| UAT checkpoint template | Story 2.0 acceptance criteria |
| MDA reconciliation + abbreviation + aliases | Story 2.1 acceptance criteria |
| Sports Council CSV fixture | Story 2.3 acceptance criteria |
| Team agreements (7, 8, 9) | Referenced in all story reviews |

No action items are left untracked.

---

*Generated from Epic 1+14 combined retrospective session, 2026-02-24*
